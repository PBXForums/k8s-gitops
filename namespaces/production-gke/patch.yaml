---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-cert
  namespace: istio-system
spec:
  dnsNames:
    - gke.raspbernetes.com
    - '*.gke.raspbernetes.com'
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: external-dns
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: external-dns
      version: 4.5.3
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
      interval: 10m
  values:
    policy: upsert-only
    cloudflare:
      proxied: false
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.helm.sh/stable
      chart: oauth2-proxy
      version: 3.2.5
      sourceRef:
        kind: HelmRepository
        name: kubernetes-stable-charts
        namespace: flux-system
      interval: 10m
  values:
    image:
      tag: v5.1.1-amd64
    extraArgs:
      oidc-issuer-url: https://dex.gke.raspbernetes.com
      cookie-domain: .raspbernetes.com
      whitelist-domain: .raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dex
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.helm.sh/stable
      chart: dex
      version: 2.15.2
      sourceRef:
        kind: HelmRepository
        name: kubernetes-stable-charts
        namespace: flux-system
      interval: 10m
  values:
    certs:
      image: gcr.io/google_containers/kubernetes-dashboard-init-arm
    config:
      issuer: https://dex.gke.raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      # CRDs are applied in core/crd/kube-prometheus-stack.yaml
      # renovate: registryUrl=https://prometheus-community.github.io/helm-charts
      chart: kube-prometheus-stack
      version: 13.4.1
      sourceRef:
        kind: HelmRepository
        name: prometheus-community-charts
        namespace: flux-system
      interval: 10m
  values:
    grafana:
      grafana.ini:
        server:
          root_url: https://grafana.gke.raspbernetes.com
        auth.generic_oauth:
          auth_url: https://dex.gke.raspbernetes.com/auth
          token_url: https://dex.gke.raspbernetes.com/token
          api_url: https://dex.gke.raspbernetes.com/userinfo
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: grafana
  namespace: observability
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'grafana.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: auth
  namespace: network
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'auth.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dex
  namespace: network
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'dex.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sealed-secrets
  namespace: kube-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'sealed-secrets.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: thanos
  namespace: observability
spec:
  hosts:
    - 'thanos.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kiali
  namespace: observability
spec:
  hosts:
    - 'kiali.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: receiver
  namespace: flux-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'receiver.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: jaeger
  namespace: istio-system
spec:
  hosts:
    - 'jaeger.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: hubble-ui
  namespace: kube-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'hubble.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: prometheus
  namespace: observability
spec:
  hosts:
    - 'prometheus.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: alert-manager
  namespace: observability
spec:
  hosts:
    - 'alert-manager.gke.raspbernetes.com'
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  name: dex-helm-values
  namespace: network
spec:
  encryptedData:
    values.yaml: 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
