---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: wildcard-cert
  namespace: istio-system
spec:
  dnsNames:
    - gke.raspbernetes.com
    - '*.gke.raspbernetes.com'
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: external-dns
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.bitnami.com/bitnami
      chart: external-dns
      version: 4.5.3
      sourceRef:
        kind: HelmRepository
        name: bitnami-charts
        namespace: flux-system
      interval: 10m
  values:
    policy: upsert-only
    cloudflare:
      proxied: false
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: oauth2-proxy
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.helm.sh/stable
      chart: oauth2-proxy
      version: 3.2.5
      sourceRef:
        kind: HelmRepository
        name: kubernetes-stable-charts
        namespace: flux-system
      interval: 10m
  values:
    image:
      tag: v5.1.1-amd64
    extraArgs:
      oidc-issuer-url: https://dex.gke.raspbernetes.com
      cookie-domain: .raspbernetes.com
      whitelist-domain: .raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: dex
  namespace: network
spec:
  interval: 5m
  chart:
    spec:
      # renovate: registryUrl=https://charts.helm.sh/stable
      chart: dex
      version: 2.15.2
      sourceRef:
        kind: HelmRepository
        name: kubernetes-stable-charts
        namespace: flux-system
      interval: 10m
  values:
    certs:
      image: gcr.io/google_containers/kubernetes-dashboard-init-arm
    config:
      issuer: https://dex.gke.raspbernetes.com
---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: observability
spec:
  interval: 5m
  chart:
    spec:
      # CRDs are applied in core/crd/kube-prometheus-stack.yaml
      # renovate: registryUrl=https://prometheus-community.github.io/helm-charts
      chart: kube-prometheus-stack
      version: 13.4.1
      sourceRef:
        kind: HelmRepository
        name: prometheus-community-charts
        namespace: flux-system
      interval: 10m
  values:
    grafana:
      grafana.ini:
        server:
          root_url: https://grafana.gke.raspbernetes.com
        auth.generic_oauth:
          auth_url: https://dex.gke.raspbernetes.com/auth
          token_url: https://dex.gke.raspbernetes.com/token
          api_url: https://dex.gke.raspbernetes.com/userinfo
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: grafana
  namespace: observability
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'grafana.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: auth
  namespace: network
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'auth.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: dex
  namespace: network
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'dex.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: sealed-secrets
  namespace: kube-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'sealed-secrets.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: thanos
  namespace: observability
spec:
  hosts:
    - 'thanos.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: kiali
  namespace: observability
spec:
  hosts:
    - 'kiali.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: receiver
  namespace: flux-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'receiver.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: jaeger
  namespace: istio-system
spec:
  hosts:
    - 'jaeger.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: hubble-ui
  namespace: kube-system
  annotations:
    external-dns.alpha.kubernetes.io/target: gke.raspbernetes.com
    external-dns.alpha.kubernetes.io/external: 'true'
spec:
  hosts:
    - 'hubble.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: prometheus
  namespace: observability
spec:
  hosts:
    - 'prometheus.gke.raspbernetes.com'
---
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: alert-manager
  namespace: observability
spec:
  hosts:
    - 'alert-manager.gke.raspbernetes.com'
---
apiVersion: bitnami.com/v1alpha1
kind: SealedSecret
metadata:
  creationTimestamp: null
  name: dex-helm-values
  namespace: network
spec:
  encryptedData:
    values.yaml: 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
